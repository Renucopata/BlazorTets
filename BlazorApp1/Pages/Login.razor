@page "/"
@layout LoginLayout
@inject NavigationManager NavManager





<head>
	<PageTitle>Login</PageTitle>

	<link rel="icon" type="image/png" href="images/icons/favicon.ico"/>
	<link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="fonts/Linearicons-Free-v1.0.0/icon-font.min.css">
	<link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">
	<link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">
	<link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">
	<link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">
	<link rel="stylesheet" type="text/css" href="vendor/daterangepicker/daterangepicker.css">
	<link rel="stylesheet" type="text/css" href="css/util.css">
	<link rel="stylesheet" type="text/css" href="css/main.css">

</head>
@if (showAuthenticationError){
	<div class="alert alert-danger" role="alert">
		<p>authenticationErrorText</p>
	</div>

}
<body>
	
	<div class="limiter">
		<div class="container-login100" style="background-image: url('images/PCLoginBackground.jpg'); background-size: 75%;">
			<div class="wrap-login100 p-t-30 p-b-50">
				<span class="login100-form-title p-b-41">
					Cuenta de usuario
				</span>
				<EditForm class="login100-form validate-form p-b-33 p-t-5" Model="user" OnValidSubmit="ExecuteLogin">
					<div class="wrap-input100 validate-input">
						<InputText class="input100" @bind-Value="user.UserName" placeholder="Usuario" />
						<span class="focus-input100" data-placeholder="&#xe82a;"></span>
					</div>

					<div class="wrap-input100 validate-input">
						<InputText class="input100" @bind-Value="user.Password" placeholder="Contraseña" />
						<span class="focus-input100" data-placeholder="&#xe80f;"></span>
					</div>

					<div class="container-login100-form-btn m-t-32">
						<button type="submit" class="login100-form-btn">
							Entrar
						</button>
					</div>
				</EditForm>
			</div>
		</div>
	</div>
	

	<div id="dropDownSelect1"></div>
	



</body>




@code {
	AuthenticationUserModel user = new();

	private bool showAuthenticationError = false;
	private string authenticationErrorText = "";

	private async Task ExecuteLogin()
	{
		if (string.IsNullOrEmpty(user.UserName) || string.IsNullOrEmpty(cont))
			return null;
		var token = new JwtSecurityTokenHandler();
		var LlaveTk = Encoding.ASCII.GetBytes(secretKey);
		var credenciales = new SecurityTokenDescriptor
			{
				Subject = new ClaimsIdentity(new Claim[] {
					new Claim("user",usuario),
					new Claim("pass",cont)
				}),
				SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(LlaveTk), SecurityAlgorithms.HmacSha256)
			};
		var salidaTk = token.CreateToken(credenciales);
		var TK = token.WriteToken(salidaTk);
		var API = new RestClient(baseUrl);
		API.RemoteCertificateValidationCallback = (sender, certificate, chain, sslPolicyErrors) => true;
		API.Timeout = -1;
		var consulta = new RestRequest(Method.POST);
		consulta.AddHeader("Content-Type", "application/json");
		var body = "{\r\n\n    \"token\":\"" + TK + "\"\r\n\n}";
		consulta.AddParameter("application/json", body, ParameterType.RequestBody);
		IRestResponse<ModeloUsuario> resp = API.Execute<ModeloUsuario>(consulta);
		if (!string.IsNullOrEmpty(resp.Content))
		{
			var json = JsonConvert.DeserializeObject<ModeloUsuario>(resp.Content.Substring(1, resp.Content.Length - 2));
			return json;
		}
		else
		{
			ModeloUsuario respuesta = new ModeloUsuario() { login = "SIN RESPUESTA", cargo = "SCRUM MASTER A" };
			return respuesta;
		}
		
	}







 



}
